apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "newapi.fullname" . }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: {{ include "newapi.name" . }}
  template:
    metadata:
      labels:
        app: {{ include "newapi.name" . }}
    spec:
      {{- $needsPvc := eq (include "newapi.needsPVC" .) "true" }}
      containers:
        - name: new-api
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          {{- $args := list -}}
          {{- range .Values.extraArgs }}
          {{- $args = append $args (printf "%v" .) -}}
          {{- end -}}
          {{- if .Values.mountLogs.enabled -}}
          {{- $args = append $args "--log-dir" -}}
          {{- $args = append $args (printf "%v" .Values.mountLogs.path) -}}
          {{- end -}}
          {{- if gt (len $args) 0 }}
          args:
          {{- range $args }}
            - {{ . | quote }}
          {{- end }}
          {{- end }}
          env:
          # 1) 先注入通用 env（如果你有 .Values.env）
          {{- range $k, $v := .Values.env }}
            - name: {{ $k }}
              value: {{ $v | quote }}
          {{- end }}
          {{- if .Values.database.usePostgres }}
            - name: SQL_DSN
              value: {{ required "database.externalPostgresDsn is required when database.usePostgres=true" .Values.database.externalPostgresDsn | quote }}
          {{- end }}
          # 2) 再注入 Redis（根据 .Values.redis.enabled / host / auth）
          {{- $externalRedisConn := default "" (index .Values.env "REDIS_CONN_STRING") }}
          {{- $hasExternalRedisConn := ne $externalRedisConn "" }}
          {{- if .Values.redis.enabled }}
            {{- if .Values.redis.auth.enabled }}
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "newapi.redis.authSecretName" . }}
                  key: {{ include "newapi.redis.authSecretKey" . }}
            - name: REDIS_CONN_STRING
              value: "{{ .Values.redis.scheme }}://:$(REDIS_PASSWORD)@{{ include "newapi.redis.serviceName" . }}:{{ .Values.redis.service.port }}"
              {{- else }}
            - name: REDIS_CONN_STRING
              value: "{{ .Values.redis.scheme }}://{{ include "newapi.redis.serviceName" . }}:{{ .Values.redis.service.port }}"
              {{- end }}
          {{- else }}
            {{- if not $hasExternalRedisConn }}
              {{- $addr := include "newapi.redis.externalAddress" . }}
              {{- if .Values.redis.auth.enabled }}
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "newapi.redis.authSecretName" . }}
                  key: {{ include "newapi.redis.authSecretKey" . }}
            - name: REDIS_CONN_STRING
              value: "{{ .Values.redis.scheme }}://:$(REDIS_PASSWORD)@{{ $addr }}"
                {{- else }}
            - name: REDIS_CONN_STRING
              value: "{{ .Values.redis.scheme }}://{{ $addr }}"
                {{- end }}
            {{- end }}
          {{- end }}
          {{- if $needsPvc }}
          volumeMounts:
            {{- if not .Values.database.usePostgres }}
            - name: app-storage
              mountPath: /data
              subPath: {{ .Values.paths.dataSubPath | quote }}
            {{- end }}
            {{- if .Values.mountLogs.enabled }}
            - name: app-storage
              mountPath: {{ .Values.mountLogs.path | quote }}
              subPath: {{ .Values.paths.logsSubPath | quote }}
            {{- end }}
          {{- end }}

          readinessProbe:
            httpGet:
              path: /api/status
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3

          livenessProbe:
            httpGet:
              path: /api/status
              port: http
            initialDelaySeconds: 20
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          resources:
{{ toYaml .Values.resources | indent 12 }}

      {{- if $needsPvc }}
      volumes:
        - name: app-storage
          persistentVolumeClaim:
            claimName: {{ if .Values.persistence.existingClaim -}}
              {{ .Values.persistence.existingClaim | quote }}
            {{- else -}}
              {{ include "newapi.fullname" . }}
            {{- end }}
      {{- end }}